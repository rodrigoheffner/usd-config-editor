<html>

<head>
    <script type="text/javascript">
        let cy;
        let elements = [];
        setTimeout (function(){
            getText();
        }, 1000)

        
        function getText(){
            // read text from URL location
            var request = new XMLHttpRequest();
            request.open('GET', 'data.xml', true);
            request.send(null);
            request.onreadystatechange = function () {
                if (request.readyState === 4 && request.status === 200) {
                    var type = request.getResponseHeader('Content-Type');
                    if (type.indexOf("text") !== 1) {
                        let usdConfigAsJson = JSON.parse(xml2json(request.responseText, {compact: true, spaces: 4}));
                        let graphElements = transformUsdConfig(usdConfigAsJson);
                        createGraph(graphElements);
                        return true;
                    }
                }
            }
        }
        
        function transformUsdConfig(usdConfigAsJson) {
//            let elements = [];
            
            
            console.log(usdConfigAsJson)
            
            // for each entity...
            for (let i = 0; i < usdConfigAsJson.entities.entity.length; i++) {
                let entity = usdConfigAsJson.entities.entity[i];
                
                let parentNode = {
                    data: {
                        id: entity._attributes.name
                    }
                }
                elements.push(parentNode);
                
                // for each record...
                for (let j = 0; j < entity.records.record.length; j++) {
                    let record = entity.records.record[j];

                    let graphElement = {
                        group: "nodes",
                        data: {
                            id: entity._attributes.name + ":" + record._attributes.id,
                            parent: entity._attributes.name
                        }
                    }
                    
                    // for each attribute...
                    for(let k = 0; k < record.field.length; k++){
                        let field = record.field[k];
                        
                        graphElement.data[field._attributes.name] = {}
                        
                        // for each field...
                        for (var key in field._attributes) {
                            if (field._attributes.hasOwnProperty(key)) {
                               let value = field._attributes[key];
                                
                                if (key != "name") {
                                    graphElement.data[field._attributes.name][key] = value;
                                }
                            }
                        }
                    }
                    
                    elements.push(graphElement);
                }
                
                if (entity.m2mrelationships && entity.m2mrelationships.m2mrelationship){
                    for (let j = 0; j < entity.m2mrelationships.m2mrelationship.length; j++){
                        let relationship = entity.m2mrelationships.m2mrelationship[j];


                        for (let k = 0; k < relationship.targetids.targetid.length; k++){
                            let target = relationship.targetids.targetid[k];

                            let connection = {
                                group: "edges",
                                data: {
                                    id: i + "_" + j + "_" + k + "_" + relationship._attributes.sourceid,
                                    source: entity._attributes.name + ":" + relationship._attributes.sourceid,
                                    target: elements.filter(function(ele){return ele.data.id.indexOf("fe02bd12-ca8e-e611-80d3-00155d889a55") !== -1})[0].data.id
                                }
                            };

                            elements.push(connection);
                        }
                    }
                }
            }
            
            return elements;
        }
        
        function createGraph(graphElements) {
            console.log(graphElements)
            
            cy = cytoscape({
                container: document.getElementById('graph'), // container to render in
                elements: graphElements,
                style: [ // the stylesheet for the graph
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#666',
                            'label': 'data(id)'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle'
                        }
                    }
                ],
                layout: {
                    name: 'cose-bilkent',
                    animate: false
                },
            });
            
            cy.nodes().forEach(function(n){
                let pos = n.position;
                
                n.qtip({
                  content: JSON.stringify(n.data()),
                  position: {
                    my: 'top center',
                    at: 'bottom center'
                  },
                  style: {
                    classes: 'qtip-bootstrap',
                    tip: {
                      width: 16,
                      height: 8
                    }
                  }
                });
            });
        }
        
    </script>
</head>

<body>
    <div id="graph" style="width:1000px; height:800px;"></div>
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script type="text/javascript" src="js/cytoscape.js"></script>
    <script type="text/javascript" src="js/xml-js.js"></script>
    
    <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.js"></script>
    <link href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.css" rel="stylesheet" type="text/css" />
    
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cose-bilkent/1.6.5/cytoscape-cose-bilkent.js"></script>
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-qtip/2.7.0/cytoscape-qtip.js"></script>
</body>

</html>
