<html>

<head>
    <script type="text/javascript">
        setTimeout (function(){
            getText();
        }, 1000)

        
        function getText(){
            // read text from URL location
            var request = new XMLHttpRequest();
            request.open('GET', 'data.xml', true);
            request.send(null);
            request.onreadystatechange = function () {
                if (request.readyState === 4 && request.status === 200) {
                    var type = request.getResponseHeader('Content-Type');
                    if (type.indexOf("text") !== 1) {
                        let usdConfigAsJson = JSON.parse(xml2json(request.responseText, {compact: true, spaces: 4}));
                        let graphElements = transformUsdConfig(usdConfigAsJson);
                        createGraph(graphElements);
                        return true;
                    }
                }
            }
        }
        
        function transformUsdConfig(usdConfigAsJson) {
            let elements = [];
            
            console.log(usdConfigAsJson)
            
            // for each entity...
            for (let i = 0; i < usdConfigAsJson.entities.entity.length; i++) {
                let entity = usdConfigAsJson.entities.entity[i];
                
                // for each record...
                for (let j = 0; j < entity.records.record.length; j++) {
                    let record = entity.records.record[j];
                    
                    let graphElement = {
                        data: {
                            id: record._attributes.id
                        }
                    }
                    
                    // for each attribute...
                    for(let k = 0; k < record.field.length; k++){
                        let field = record.field[k];
                        
                        graphElement.data[field._attributes.name] = {}
                        
                        // for each field...
                        for (var key in field._attributes) {
                            if (field._attributes.hasOwnProperty(key)) {
                               let value = field._attributes[key];
                                
                                if (key != "name") {
                                    graphElement.data[field._attributes.name][key] = value;
                                }
                            }
                        }
                    }
                    
                    elements.push(graphElement);
                }
                
                if (entity.m2mrelationships && entity.m2mrelationships.m2mrelationship){
                    for (let j = 0; j < entity.m2mrelationships.m2mrelationship.length; j++){
                        let relationship = entity.m2mrelationships.m2mrelationship[j];


                        for (let k = 0; k < relationship.targetids.targetid.length; k++){
                            let target = relationship.targetids.targetid[k];

                            let connection = {
                                data: {
                                    id: i + "_" + j + "_" + k + "_" + relationship._attributes.sourceid,
                                    source: relationship._attributes.sourceid,
                                    target: target._text
                                }
                            };

                            elements.push(connection);
                        }
                    }
                }
            }
            
            return elements;
        }
        
        function createGraph(graphElements) {
            console.log(graphElements)
            
            var cy = cytoscape({
                container: document.getElementById('graph'), // container to render in
                elements: graphElements,
                
//                [ // list of graph elements to start with
//                    { // node a
//                        data: {
//                            id: 'a'
//                        }
//                    },
//                    { // node b
//                        data: {
//                            id: 'b'
//                        }
//                    },
//                    { // edge ab
//                        data: {
//                            id: 'ab',
//                            source: 'a',
//                            target: 'b'
//                        }
//                    }
//                ],
                style: [ // the stylesheet for the graph
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#666',
                            'label': 'data(id)'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle'
                        }
                    }
                ],
                layout: {
                    name: 'grid',
                    rows: 1
                }
            });
        }
        
    </script>
</head>

<body>
    <div id="graph" style="width:500px; height:500px;"></div>
    <script type="text/javascript" src="js/cytoscape.js"></script>
    <script type="text/javascript" src="js/xml-js.js"></script>
</body>

</html>
